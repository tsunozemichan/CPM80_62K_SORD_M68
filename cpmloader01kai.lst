                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.27.0, LST:Full:4
       00C8                     FDCCOMMAND  EQU 0C8H
       00C8                     FDCSTATUS   EQU 0C8H
       00C9                     FDCTRACK    EQU 0C9H
       00CA                     FDCSECTOR   EQU 0CAH
       00CB                     FDCDATA     EQU 0CBH
       00CD                     FDCCONTROL  EQU 0CDH
       00C5                     UNKNOWN_C5  EQU 0C5H
                                
       00F8                     SIOAD   EQU 0F8H        ; SIO A CHANNEL DATA
       00F9                     SIOAC   EQU 0F9H        ; SIO A CHANNEL CONTROL
                                
       00CC                     DMA EQU 0CCH
                                
       00DE                     IO_DE   EQU 0DEH
       00CE                     IO_CE   EQU 0CEH
       00D3                     _IO_D3_ EQU 0D3H
       00E2                     _IO_E2_ EQU 0E2H
       00E3                     _IO_E3_ EQU 0E3H
                                
       1500                     READBUF EQU 01500H
       1400                     RESULT  EQU 01400H
                                
                                
000000 0000                         ORG 0H
000000 0000 F3               4      DI
       0001                     START:
000001 0001 210010          10      LD HL,01000H
000004 0004 F9               6      LD SP,HL ; stack pointer
000005 0005 210017          10      LD HL,01700H ; destination address
000008 0008 EB               4      EX DE,HL
000009 0009 212000          10      LD HL,20H ; source address
00000C 000C 010004          10      LD BC,400H ; 400H is 1kB
00000F 000F EDB0                    LDIR
000011 0011 C30017          10      JP MAIN:
                                
001700 1700                         ORG 01700H
       1700                     MAIN:
                                    ;
                                    ; 0 MEMORY FILL FROM 0 TO 100H
                                    ;
001700 1700 210000          10      LD HL,0H
001703 1703 010001          10      LD BC,100H
001706 1706 3E00             7      LD A,0H
001708 1708 CD1618          17      CALL MEMORY_FILL
                                    ;
                                    ; INITIALIZE SIO
                                    ;
00170B 170B CDE517          17      CALL SIO_INIT
                                    ;
00170E 170E 3E53             7      LD  A,'S'
001710 1710 CD0B18          17      CALL CONOUT
                                    ;
001713 1713 DBCB            11      IN A,(FDCDATA)
001715 1715 EEFF             7      XOR 0FFH
001717 1717 D3CB            11      OUT (FDCDATA),A
001719 1719 47               4      LD B,A
00171A 171A E3              19      EX (SP),HL
00171B 171B E3              19      EX (SP),HL
00171C 171C DBCB            11      IN A,(FDCDATA)
00171E 171E B8               4      CP B ; IF NOT EQUAL
00171F 171F C2E417          10      JP NZ,ABORT ; GO ABORT
001722 1722 AF               4      XOR A
001723 1723 D3CD            11      OUT (FDCCONTROL),A
001725 1725 3ED0             7      LD A,0D0H ; FORCE INT
001727 1727 CD7F17          17      CALL FDCOUT
00172A 172A 0630             7      LD B,30H
00172C 172C 10FE            13  MLOOP1: DJNZ MLOOP1
                                ;
00172E 172E CD8D17          17      CALL RESTORE
                                ;
001731 1731 3E52             7      LD  A,'R'
001733 1733 CD0B18          17      CALL CONOUT
                                ;
                                ;------------------------------------------------------------
                                ;  Side 0 process
                                ;------------------------------------------------------------
                                ;
                                ; SEEK
                                ;
                                ; FDC \DDENS setting
                                ;   LD D,24H ; Side 1 & High density mode
001736 1736 1604             7      LD D,04H ; Side 0 & High density mode
                                ;   LD D,44H ; Side 0 & LOW density mode
                                ;
001738 1738 1E07             7      LD E,07H  ; TARGET TRACK No.7, at CP/M SYS
                                ;
       173A                     DO_SEEK0:
00173A 173A CD9F17          17      CALL SEEK
00173D 173D 2802            12      JR Z,GO_DMA0
00173F 173F 18F9            12      JR DO_SEEK0
       1741                     GO_DMA0:
001741 1741 060E             7      LD B,0EH ; LOOP COUNT is 0EH(14) sectors
001743 1743 1604             7      LD D,04H ; FDCCONTROL COMMAND is Side 0 & High density mode
                                ;
001745 1745 0E0D             7      LD C,0DH ; INITIAL SECTOR NO. is 0DH(13) to 26 sector reading
                                ;
       1747                     READ_LOOP0:
001747 1747 CDB817          17      CALL GO_DMA_AND_READ0
00174A 174A 0C               4      INC C
00174B 174B 3A4218          13      LD A,(dma_trans_add) ; memory address of DMA transfer address
00174E 174E 3C               4      INC A ; 256 byte incriment
00174F 174F 324218          13      LD (dma_trans_add),A
001752 1752 10F3            13      DJNZ READ_LOOP0
                                
001754 1754 3E30             7      LD  A,'0'
001756 1756 CD0B18          17      CALL CONOUT
                                
                                ;------------------------------------------------------------
                                ;  Side 1 process
                                ;------------------------------------------------------------
                                
                                ;
                                ; SEEK
                                ;
                                ; FDC \DDENS setting
001759 1759 1624             7      LD D,24H ; Side 1 & High density mode
                                ;   LD D,4H ; Side 0 & High density mode
                                ;   LD D,44H ; Side 0 & LOW density mode
                                ;
                                ;
00175B 175B 1E07             7      LD E,07H  ; TARGET TRACK No. 7 at CP/M SYS
                                ;
                                ;
       175D                     DO_SEEK1:
00175D 175D CD9F17          17      CALL SEEK
001760 1760 2802            12      JR Z,GO_DMA1
001762 1762 18F9            12      JR DO_SEEK1
       1764                     GO_DMA1:
001764 1764 0612             7      LD B,12H ; LOOP COUNT is 12H(18) sectors. 
001766 1766 1624             7      LD D,24H ; FDCCONTROL COMMAND is side 1 & High density mode
                                ;
001768 1768 0E01             7      LD C,01H ; INITIAL SECTOR NO.1 to 12H(18) sector reading
                                ;
       176A                     READ_LOOP1:
00176A 176A CDCE17          17      CALL GO_DMA_AND_READ1
00176D 176D 0C               4      INC C
00176E 176E 3A4218          13      LD A,(dma_trans_add)
001771 1771 3C               4      INC A
001772 1772 324218          13      LD (dma_trans_add),A
001775 1775 10F3            13      DJNZ READ_LOOP1
                                ;   LD A,08H
                                ;   CALL FDCOUT ; FDD is Not ready
                                ;   LD A,83H
                                ;   OUT (DMA),A
001777 1777 3E45             7      LD  A,'E'
001779 1779 CD0B18          17      CALL CONOUT
                                
                                ;   CALL RESTORE
                                ;   LD  A,'Z'
                                ;   CALL CONOUT
                                
00177C 177C C300F2          10      JP 0F200H ; Jump F200H @ 62k memory model. 
                                ;   HALT
                                ;
                                ;
                                ; ----------------------------------------------------------------
                                ;
                                ;
                                ; FDC COMMAND OUT subroutine
                                ;
       177F                     FDCOUT:
00177F 177F D3C8            11      OUT (FDCCOMMAND),A
001781 1781 3E30             7      LD A,30H
001783 1783 3D               4  WLOOP: DEC A
001784 1784 20FD            12      JR NZ,WLOOP
       1786                     LOOP2:
001786 1786 DBC8            11      IN A,(FDCSTATUS)
001788 1788 CB47             8      BIT 0x0,A ; BUSY IS CLEAR?
00178A 178A 20FA            12      JR NZ,LOOP2
00178C 178C C9              10      RET
                                ;
                                ; RESTORE subroutine
                                ;
       178D                     RESTORE:
                                ;   LD A,(RESTORE_COUNT)
                                ;   DEC A
                                ;   JP Z,ERROR_RESTORE
                                ;   LD (RESTORE_COUNT),A
       178D                     RESTORE_LOOP:
00178D 178D 3E44             7      LD A,44H ;  \DDENS is HIGH. Low density mode. 
00178F 178F D3CD            11      OUT (FDCCONTROL),A
001791 1791 3E0C             7      LD A,0CH ; restore command
001793 1793 CD7F17          17      CALL FDCOUT
001796 1796 CB7F             8      BIT 7,A ; Not Ready?
001798 1798 20F3            12      JR NZ,RESTORE_LOOP
00179A 179A E698             7      AND 98H
00179C 179C 20EF            12      JR NZ,RESTORE
00179E 179E C9              10      RET
                                ;
                                ; SEEK subroutine
                                ; D is fdccontrol COMMAND
                                ; if D=0x44 : \DDEN is HIGH. Low density mode. 
                                ; if D=0x4  : \DDEN is LOW. High density mode. 
                                ; if D=0x24 : Side 1 and High density mode.
                                ; E is Track No.
                                ;
       179F                     SEEK:
00179F 179F 7A               4      LD A,D
0017A0 17A0 D3CD            11      OUT (FDCCONTROL),A
0017A2 17A2 7B               4      LD A,E
0017A3 17A3 D3CB            11      OUT (FDCDATA),A
0017A5 17A5 3E1C             7      LD A,1CH ; SEEK COMMAND
0017A7 17A7 CD7F17          17      CALL FDCOUT
0017AA 17AA E698             7      AND 98H
0017AC 17AC C9              10      RET
                                ;
                                ; DMA setting & Go
                                ; HL is Address of DMA Command chain
                                ;       but top value is No of DMA Command chain
       17AD                     DMA_ON:
0017AD 17AD E5              11      PUSH HL
0017AE 17AE C5              11      PUSH BC
0017AF 17AF 46               7      LD B,(HL)
0017B0 17B0 23               6      INC HL
0017B1 17B1 0ECC             7      LD C,DMA
0017B3 17B3 EDB3                    OTIR
0017B5 17B5 C1              10      POP BC
0017B6 17B6 E1              10      POP HL
0017B7 17B7 C9              10      RET
                                ;
                                ; DMA setting & FDD read FOR SIDE 0
                                ; C is Sector No.
                                ; D is Control word.
                                ;
       17B8                     GO_DMA_AND_READ0:
0017B8 17B8 79               4      LD A,C
0017B9 17B9 D3CA            11      OUT (FDCSECTOR),A
0017BB 17BB 7A               4      LD A,D
0017BC 17BC D3CD            11      OUT (FDCCONTROL),A
0017BE 17BE 213018          10      LD HL,DMA_COMMANDS
0017C1 17C1 CDAD17          17      CALL DMA_ON
0017C4 17C4 E620             7      AND 20H
0017C6 17C6 3E82             7      LD A,82H ; READ DATA COMMAND for Side 0
                                ;   LD A,8AH ; READ DATA COMMAND for Side 1
                                ;   JR NZ,DO_FDC0
                                ;   OR 08H
       17C8                     DO_FDC0:
0017C8 17C8 CD7F17          17      CALL FDCOUT
0017CB 17CB E6FC             7      AND 0FCH
0017CD 17CD C9              10      RET
                                ;
                                ; DMA setting & FDD read FOR SIDE 1
                                ; C is Sector No.
                                ; D is Control word.
                                ;
       17CE                     GO_DMA_AND_READ1:
0017CE 17CE 79               4      LD A,C
0017CF 17CF D3CA            11      OUT (FDCSECTOR),A
0017D1 17D1 7A               4      LD A,D
0017D2 17D2 D3CD            11      OUT (FDCCONTROL),A
0017D4 17D4 213018          10      LD HL,DMA_COMMANDS
0017D7 17D7 CDAD17          17      CALL DMA_ON
0017DA 17DA E620             7      AND 20H
                                ;   LD A,82H ; READ DATA COMMAND for Side 0
0017DC 17DC 3E8A             7      LD A,8AH ; READ DATA COMMAND for Side 1
                                ;   JR NZ,DO_FDC1
                                ;   OR 08H
       17DE                     DO_FDC1:
0017DE 17DE CD7F17          17      CALL FDCOUT
0017E1 17E1 E6FC             7      AND 0FCH
0017E3 17E3 C9              10      RET
                                ;
                                ; ABORT
                                ;
       17E4                     ABORT:
                                ;   LD A,"A"
                                ;   CALL CONOUT
0017E4 17E4 76               4      HALT
                                ;
                                ; SIO INITIALIZE
                                ;
       17E5                     SIO_INIT:
                                    ;; Initialize SIO
0017E5 17E5 DBF9            11      IN  A,(SIOAC)
                                    ;; Reset both Ch.
0017E7 17E7 3E18             7      LD  A,18H
0017E9 17E9 D3F9            11      OUT (SIOAC),A
                                    ;; Ch.A WR1
0017EB 17EB 3E01             7      LD  A,01H
0017ED 17ED D3F9            11      OUT (SIOAC),A
0017EF 17EF AF               4      XOR A
0017F0 17F0 D3F9            11      OUT (SIOAC),A
                                    ;; Ch.A WR4
0017F2 17F2 3E04             7      LD  A,04H
0017F4 17F4 D3F9            11      OUT (SIOAC),A
0017F6 17F6 3E44             7      LD  A,44H       ; x16 1 N
0017F8 17F8 D3F9            11      OUT (SIOAC),A
                                    ;; Ch.A WR3
0017FA 17FA 3E03             7      LD  A,03H
0017FC 17FC D3F9            11      OUT (SIOAC),A
0017FE 17FE 3EC1             7      LD  A,0C1H      ; 8bit Receiver enable
001800 1800 D3F9            11      OUT (SIOAC),A
                                    ;; Ch.A WR5
001802 1802 3E05             7      LD  A,05H
001804 1804 D3F9            11      OUT (SIOAC),A
001806 1806 3EEA             7      LD  A,0EAH      ; 8bit Transmitter enable
001808 1808 D3F9            11      OUT (SIOAC),A
00180A 180A C9              10      RET
                                ;
                                ; CONOUT
                                ;
       180B                     CONOUT:
00180B 180B F5              11      PUSH    AF
       180C                     CO0:
00180C 180C DBF9            11      IN  A,(SIOAC)
00180E 180E E604             7      AND 04H
001810 1810 28FA            12      JR  Z,CO0
001812 1812 F1              10      POP AF
001813 1813 D3F8            11      OUT (SIOAD),A
001815 1815 C9              10      RET
                                ;
                                ; MEMORY FILL
                                ;
       1816                     MEMORY_FILL:
001816 1816 77               7      LD (HL),A
001817 1817 54               4      LD D,H
001818 1818 5D               4      LD E,L
001819 1819 13               6      INC DE
00181A 181A 0B               6      DEC BC
00181B 181B 78               4      LD A,B
00181C 181C B1               4      OR C
00181D 181D C8              11      RET Z
00181E 181E EDB0                    LDIR
001820 1820 C9              10      RET
                                
001821 1821 FF                  RESTORE_COUNT DB 0FFH
001822 1822 0A                  READ_COUNT DB 0AH
001823 1823 0A                  SEEK_COUNT DB 0AH
                                
                                
                                ;
                                ; DMA command chain Parameters
                                ;
001830 1830                         ORG 01830H
       1830                     DMA_COMMANDS:
001830 1830 15C3C3C3C33CC3          DB 15H,0C3H,0C3H,0C3H,0C3H,03CH,0C3H
001837 1837 BB01BF                  DB 0BBH,01H,9BFH
00183A 183A 6DCBFF002C108D          DB 6DH,0CBH,0FFH,00H,02CH,010H,08DH
001841 1841 00                      DB 00H
001842 1842 DC                  dma_trans_add:  DB 0DCH ; DC00H IS 62K MEMORY MODEL
001843 1843 9A                      DB 9AH
001844 1844 CF87                    DB 0CFH,87H
                                
                                
                                
                                END
[EOF:cpmloader01kai.z80:UTF_8]
